<!-- START of: finna - RecordDriver/SolrDefault/core.phtml -->
<?
  $img = $this->recordImage($this->record($this->driver));
  $thumbnail = false;
  $thumbnailAlignment = $this->record($this->driver)->getThumbnailAlignment('result');
  ob_start(); ?>
  <div class="media-<?=$thumbnailAlignment ?> col-sm-3 col-md-2">
    <div class="row">
      <div class="col-xs-12 image-information">
        <div class="cover-wrapper">
          <? /* Display thumbnail if appropriate: */ ?>
          <? if ($img): ?>
            <?=$img->render('record', ['small' => ['w' => 50, 'h' => 50], 'medium' => ['w' => 1200, 'h' => 1200]]) ?>
          <? endif;?>
          <? /* Display qrcode if appropriate: */ ?>
          <? $QRCode = $this->record($this->driver)->getQRCode("core"); ?>
          <? if ($QRCode): ?>
            <div class="visible-print inline-block"><img alt="<?=$this->transEsc('QR Code')?>" class="qrcode" src="<?=$this->escapeHtmlAttr($QRCode);?>"/></div>
          <? endif; ?>
        </div>
        <? // if you have a preview tab but want to move or remove the preview link
           // from this area of the record view, this can be split into
           // getPreviewData() (should stay here) and
           // getPreviewLink() (can go in your desired tab) ?>
        <?=$this->record($this->driver)->getPreviews()?>
      </div>
    </div>

    <div class="row record-rating">
      <div class="col-xs-12 rating-stars">
        <div onclick="$('a.usercomments').click();">
          <?=$this->record($this->driver)->getRating()?>
        </div>
      </div>
    </div>
    <? if ($template = $this->content()->findTemplateForLng("content/Additions/record-post-toolbar")): ?>
    <div class="row">
      <div class="col-xs-12 record-post-toolbar">
        <?=$this->render($template)?>
      </div>
    </div>
    <? endif; ?>
  </div>
  <? $thumbnail = ob_get_contents(); ?>
<? ob_end_clean(); ?>
<? $this->headScript()->appendFile("finna-record.js"); ?>
<div class="media row" vocab="http://schema.org/" resource="#record" typeof="<?=$this->driver->getSchemaOrgFormats()?> Product">
  <? if ($thumbnail && $thumbnailAlignment == 'left'): ?>
    <?=$thumbnail ?>
  <? endif; ?>
  <div class="col-sm-9 col-md-10">
    <div class="media-body record-information">
      <h1 property="name" class="record-title"><?=$this->escapeHtml($this->driver->getShortTitle())?><? if ($subtitle = $this->driver->getSubtitle()): ?>&nbsp;: <?=$this->escapeHtml($subtitle) ?><? endif; ?></h1>
      <? if ($titleAltScript = $this->driver->tryMethod('getShortTitleAltScript')): ?>
        <div class="record-title-alt-script">
          <?=$this->escapeHtml($titleAltScript)?><? if ($subtitleAltScript = $this->driver->tryMethod('getSubtitleAltScript')): ?>&nbsp;: <?=$this->escapeHtml($subtitleAltScript)?><? endif; ?>
        </div>
      <? endif; ?>
      <? if ($uniformTitles = $this->driver->tryMethod('getUniformTitles')): ?>
        <div class="record-uniform-titles">
          <? foreach ($uniformTitles as $uniformTitle): ?>
            <?=$this->escapeHtml($uniformTitle) ?><br/>
          <? endforeach; ?>
        </div>
      <? endif; ?>

      <?
        $formats = $this->driver->getFormats();
      ?>
      <?
        $openUrl = $this->openUrl($this->driver, 'record');
        $openUrlActive = $openUrl->isActive();
        // Account for replace_other_urls setting
        $urls = $this->record($this->driver)->getLinkDetails($openUrlActive);
      ?>
      <? $onlineURLs = $this->driver->getOnlineURLs(); $mergedData = $this->driver->tryMethod('getMergedRecordData'); ?>
      <? if (!empty($urls) || $openUrlActive || !empty($onlineURLs) || !empty($mergedData['urls'])): ?>
        <div class="recordURLs local-available-online-record">
          <div class="truncate-field">
            <? $renderedURLs = []; ?>
            <? if (!empty($urls)): ?>
              <? foreach ($urls as $url): ?>
                <?
                  $renderedURLs[] = $url['url'];
                  $desc = isset($url['desc']) ? $url['desc'] : $this->truncateUrl($url['url']);
                  $icon = 'fa-external-link';
                  if (!empty($url['desc'])) {
                    $map = ['Database Guide' => 'fa-info-database', 'Database Interface' => 'fa-browse-database'];
                    if (isset($map[$url['desc']])) {
                      $icon = $map[$url['desc']];
                    }
                  }
                ?>
                <div class="fulltextField">
                  <a class="fulltext" href="<?=$this->escapeHtmlAttr($this->proxyUrl($url['url'])) ?>" target="_blank" title="<?=$this->escapeHtmlAttr($url['url']) ?>"
                    <? if (!empty($url['videoSources'])): ?> data-video-sources="<?= $this->escapeHtmlAttr(json_encode($url['videoSources'])) ?>"<? endif; ?>
                    <? if (!empty($url['posterUrl'])): ?> data-poster-url="<?= $this->escapeHtmlAttr($url['posterUrl']) ?>"<? endif; ?>
                    <?=!empty($url['embed']) && $url['embed'] == 'video' ? ' data-embed-video' : '' ?>
                  >
                    <i class="fa <?=$icon?>"></i> <?=$this->transEsc('default::link_' . $desc, null, $desc) ?>
                  </a>
                  <? if (!empty($url['part'])): ?> <span class="coverage"><?=$this->transEsc('default::link_' . $url['part'], null, $url['part']) ?><? endif; ?>
                </div>
              <? endforeach; ?>
            <? endif; ?>
            <? if (!empty($onlineURLs) || !empty($mergedData['urls'])): ?>
              <? foreach (!empty($mergedData['urls']) ? $mergedData['urls'] : $onlineURLs as $url): ?>
                <? if (in_array($url['url'], $renderedURLs)) { continue; } ?>
                <div class="fulltextField"><a class="fulltext" href="<?=$this->escapeHtmlAttr($this->proxyUrl($url['url'])) ?>" target="_blank" title="<?=$this->escapeHtmlAttr($url['url']) ?>"><i class="fa fa-external-link"></i> <?=!empty($url['text']) ? $this->transEsc('default::link_' . $url['text'], null, $url['text']) : $this->escapeHtml($this->truncateUrl($url['url'])) ?></a>
                <? if (!empty($url['part'])): ?> <span class="coverage"><?=$this->transEsc('default::link_' . $url['part'], null, $url['part']) ?><? endif; ?>
                <? if ($url['source']): ?>
                  <span class="online-source">(<?=is_array($url['source']) ? $this->transEsc('Multiple Organisations') : $this->transEsc('default::source_' . $url['source'], null, $url['source']) ?>)</span>
                <? endif; ?>
                </div>
              <? endforeach; ?>
            <? endif; ?>
          </div>
        <? if ($openUrlActive): ?>
          <?=$openUrl->renderTemplate()?>
        <? endif; ?>
        </div>
      <? endif; ?>

      <div class="record-authors" property="author">
        <? $formats = $this->driver->getFormats(); if (!empty($formats)): ?>
          <span class="recordFormat">
            <?=$this->record($this->driver)->getFormatList()?><br>
          </span>
        <? endif; ?>
        <? $results = $this->driver->getNonPresenterAuthors(); $containerTitle = $this->driver->getContainerTitle(); ?>
        <? if ($results || $containerTitle): ?>
          <div class="truncate-field">
            <? if ($results): ?>
              <span class="recordAuthors">
              <? foreach($results as $index => $author): ?>
                <?=($index > 0 ? '; ' : '')?><a href="<?=$this->record($this->driver)->getLink('author', $author['name'])?>"><?=$this->escapeHtml($author['name'])?></a><? if (!empty($author['date'])): ?><span class="author-date">, <?=$this->escapeHtml($author['date']) ?></span><? endif; ?><? if (!empty($author['role'])): ?><span class="author-role">, <?=mb_strtolower($this->transEsc('CreatorRoles::' . $author['role']), 'UTF-8') ?></span><? endif; ?>
              <? endforeach; ?>
              <? $altScriptFound = false; ?>
              <? foreach($results as $index => $author): ?>
                <? if (!empty($author['name_alt'])): ?>
                  <? if (!$altScriptFound): ?><br/><? else: ?>; <? endif; ?>
                  <?=$this->escapeHtml($author['name_alt'])?><? if (!empty($author['date'])): ?><span class="author-date">, <?=$this->escapeHtml($author['date']) ?></span><? endif; ?><? if (!empty($author['role'])): ?><span class="author-role">, <?=mb_strtolower($this->transEsc('CreatorRoles::' . $author['role']), 'UTF-8') ?></span><? endif; ?>
                  <? $altScriptFound = true; ?>
                <? endif; ?>
              <? endforeach; ?>
              </span>
            <? endif; ?>
            <? if ($containerTitle): ?>
              <?
                $containerSource = $this->driver->getSourceIdentifier();
                $containerID = $this->driver->getContainerRecordID();
              ?>
              <span class="recordContainerReference">
                <?=$this->transEsc('Published in')?> <a href="<?=($containerID ? $this->recordLink()->getUrl("$containerSource|$containerID") : $this->record($this->driver)->getLink('title', $containerTitle))?>"><?=$this->escapeHtml($containerTitle)?></a>
                <? $ref = $this->driver->getContainerReference(); if (!empty($ref)) { echo $this->escapeHtml($ref); } ?>
              </span>
            <? endif; ?>
          </div>
        <? endif; ?>
        <? $publications = $this->driver->getPublicationDetails(); if (!empty($publications)): ?>
          <span class="recordPublications">
            <? foreach ($publications as $field): ?>
              <span property="publisher" typeof="Organization">
              <? $pubName = $field->getName(); if (!empty($pubName)): ?>
                <span property="name"><?=$this->escapeHtml($pubName)?></span>
              <? endif; ?>
              </span>
              <? $pubDate = $field->getDate(); if (!empty($pubDate)): ?>
                <span property="publicationDate"><?=$this->escapeHtml($pubDate)?></span>
              <? endif; ?>
            <? endforeach; ?>
          </span>
        <? endif; ?>

        <? $edition = $this->driver->getEdition(); if (!empty($edition)): ?>
          <span class="recordEdition">
            <span property="bookEdition"><?=$this->escapeHtml($edition)?></span>
          </span>
        <? endif; ?>
      </div>

      <div class="description recordSummary">
        <span id="description_text" data-id="<?=$this->escapeHtmlAttr($this->driver->getUniqueID())?>">
          <i class="fa fa-spinner fa-spin"></i>
        </span>
      </div>

      <? if ($this->userlist()->getMode() !== 'disabled'): ?>
        <? /* Display the lists that this record is saved to */ ?>
        <div class="savedLists hidden alert alert-info" id="savedLists">
          <strong><?=$this->transEsc("Saved in")?>:</strong>
        </div>
      <? endif; ?>

      <?/* Display Main Details */?>
      <?
        $formatter = $this->recordDataFormatter();
        $coreFields = $formatter->getData(
            $driver, $formatter->filterMarcFields($formatter->getDefaults('core'))
        );
      ?>
      <? if (!empty($coreFields)): ?>
        <table class="table table-finna-record record-details record-details-more" style="table-layout:initial;">
          <? foreach ($coreFields as $key => $current): ?>
            <tr class="<?=$current['context']['class'];?>"><th><?=$this->transEsc($key)?>:</th><td><?=$current['value']?></td></tr>
          <? endforeach; ?>
        </table>
      <? endif; ?>
      <button class="btn show-details-button hidden"><?=$this->transesc('show_more_details');?> <i class="fa fa-arrow-down"></i></button>
      <button class="btn hide-details-button hidden"><?=$this->transesc('show_less_details');?> <i class="fa fa-arrow-up"></i></button>
      <?/* End Main Details */?>

      <? if ($template = $this->content()->findTemplateForLng("content/Additions/record-post-metadata")): ?>
      <div class="row">
        <div class="col-xs-12">
          <?=$this->render($template)?>
        </div>
      </div>
      <? endif; ?>
    </div>
  </div>
  <? if ($thumbnail && $thumbnailAlignment == 'right'): ?>
    <?=$thumbnail ?>
  <? endif; ?>
</div>
<!-- END of: finna - RecordDriver/SolrDefault/core.phtml -->
